#!/bin/bash
# EmpÃªche les commits directs sur main et dev

branch=$(git rev-parse --abbrev-ref HEAD)

if [[ "$branch" == "main" || "$branch" == "dev" ]]; then
  echo "âŒ Vous ne pouvez pas committer directement sur la branche '$branch'."
  echo "ğŸ‘‰ Veuillez crÃ©er une feature branch (ex: feat/ma-fonctionnalite)"
  exit 1
fi

# VÃ©rification du nom de branche
if ! [[ "$branch" =~ ^(feat|fix|hotfix)/.+$ ]]; then
  echo "âŒ Nom de branche invalide : '$branch'."
  echo "ğŸ‘‰ Seules les branches feat/, fix/, hotfix/ sont autorisÃ©es."
  exit 1
fi

echo "ğŸ¨ VÃ©rification du formatage avec Spotless..."
# SpotlessCheck renvoie un code d'erreur si le code n'est pas formatÃ© correctement
./mvnw spotless:check
result=$?
if [ $result -ne 0 ]; then
  echo "âŒ Spotless a dÃ©tectÃ© des erreurs de formatage."
  echo "ğŸ‘‰ Le code a Ã©tÃ© automatiquement reformattÃ©. Veuillez relancer le commit aprÃ¨s avoir validÃ© le reformat."
  ./mvnw spotless:apply
  exit 1
else
  echo "âœ… Le formatage Spotless est correct."
fi

echo "ğŸ” Lancement des tests unitaires et d'intÃ©gration..."
export MAVEN_OPTS="-Dfile.encoding=UTF-8"
./mvnw test -Dtest='*Test,!*E2ETest'
result=$?

if [ $result -ne 0 ]; then
  echo "âŒ Certains tests ont Ã©chouÃ©. Commit annulÃ©."
  exit 1
else
  echo "âœ… Tous les tests unitaires et d'intÃ©gration sont passÃ©s !"
fi

exit 0
